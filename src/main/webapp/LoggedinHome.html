<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>LoggedinHome Page</title>
<style>
body{
  font-family: Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  line-height: 1.5;
}	
	.header{
	 background-color: rgb(138, 43, 226);
	 width: 100%;
	 color: white;
	 padding: 20px;
	}
	.header a{
	color: white;
	}
      #SearchStock{
      text-align: center;
      }
      .container{
  	  width: 100%;
      }
      .sectionLeft{
      width: 100%;
      justify-content:flex-start;
      padding-left: 20px;
      }
      .sectionRight{
      position: absolute;
      right: 0;
      top: 100px;
      width: auto;
      padding-right: 20px;
      }
      .sectionMiddle{
      text-align: center;
      }
      #tickerTitleDisplay, #CompanyInformationTitleDisplay{
      font-size: 20px;
      }
      #searchStock input[type="text"]{
      font-size:20px;
      padding:10px;
      width:300px;
      }
      #searchStock button{
      background-color:rgb(138, 43, 226);
      border: none;
      font-size:20px;
      }
      #purchaseStock button{
      background-color:green;
      border: none;
      font-size:20px;
      }
      #Quantity{
      width:30px;
      }
      #stockPricingDisplay{
      font-size: 30px;
      }
      #timeStampDisplay{
      font-size: 13px;
      }
	</style>
</head>
<body>

<div class="header">
<div style="float: left; font-size: 20px">JoesStock</div>
<div style="float: right;">
<a href="LoggedinHome.html">Home/Search</a>
<a href="PortfolioPage.html">Portfolio</a>|
<a href="#" onclick="logoutFunction()">Logout</a>
</div>
<div style="clear: both;"></div>
</div>

<div class="container">

<div class="sectionLeft">
<div id="tickerTitleDisplay"></div> 
<div id="stockNameDisplay"></div> 
<div id="purchaseOptionDisplay"></div>
</div>
<div class="sectionMiddle">
<div id="marketStatusDisplay"></div>
<div id="summaryTitleDisplay"></div>
<div id="PriceSummaryDisplay"></div> 
<div id="CompanyInformationTitleDisplay"></div>
</div>
<div class="sectionLeft">
<div id="CompanyInformationDisplay"></div>
<div id="ErrorDisplay"></div>
</div>
<div class="sectionRight">
<div id="stockPricingDisplay"></div>
<div id="timeStampDisplay"></div>
</div>

</div>


<form id="searchStock">
	<br><br><br><br><br><br><br><br><br><br>
	<div style="text-align: center;font-size: 40px">SEARCH STOCKS</div>
	<br>
	<label for="search"></label><br>
	<input type="text" name="search" id="search" placeholder="Enter stock ticker:...">
	<button type="submit" onclick="searchStock(event)">Search</button>
</form>



<script>
 //citation: 
const buyOptionHTML = `
    <form id="purchaseStock">
        <label for="Quantity">Quantity:</label>
        <input type="number" name="Quantity" id="Quantity" min="1" required><br>
        <button type="submit" onclick="tradeBuyStock(document.getElementById('Quantity').value,event)">Buy</button>
    </form>
	`;
	const fullTimeStamp={
			year: 'numeric',
		    month: '2-digit',
		    day: '2-digit',
		    hour: '2-digit',
		    minute: '2-digit',
		    second: '2-digit',
		    hour12: false		
	}
	const onlyDateTimeStamp={
			year: 'numeric',
		    month: '2-digit',
		    day: '2-digit'
	}
	var params;
	var isOpen=0;
async function searchStock(event) {
	event.preventDefault();
	 const ticker = document.getElementById("search").value.toUpperCase();
	 const API_KEY= 'cohfcp9r01qrf6b2saqgcohfcp9r01qrf6b2sar0';
    try {
		//for QUote
        let response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${ticker}&token=${API_KEY}`);
        let json = await response.json();
        console.log("Response JSON QUOTE:", json);
        let hp = json.h;
        let lp = json.l;
        let op = json.o;
        let cp = json.pc;
        let currentPrice=json.c;
        let change=json.d;
        if(change==null){
        alert("Ticker not found! Please enter valid ticker.");
        return;
        }
        let PercentageChange=json.dp;
        //for company profile
        response = await fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${ticker}&token=${API_KEY}`);
        json = await response.json();
        console.log("Response JSON company_profile:", json);
        let ipo = json.ipo;
        let mc = json.marketCapitalization;
        let so = json.shareOutstanding;
        let web = json.weburl;
        let phone = json.phone;
        let exchange = json.exchange;
        let name = json.name;
        //for market status
        response = await fetch(`https://finnhub.io/api/v1/stock/market-status?exchange=US&token=${API_KEY}`);
        json = await response.json();
        console.log("Response JSON market-status:", json);
        const time= new Date(json.t *1000); 	
    	//citation timeStamp format includes Date()method,toLocaleString() method,const fullTimeStamp,const onlyDateTimeStamp construction from :https://www.w3schools.com/jsref/jsref_obj_date.asp
        console.log("isOpen="+isOpen);
        document.getElementById('searchStock').style.display = 'none';
	 	document.getElementById('stockNameDisplay').innerHTML = name+'<br>'+ exchange+'<br>';
	 	document.getElementById('tickerTitleDisplay').innerHTML =ticker.toUpperCase()+'<br>';
	 	document.getElementById('purchaseOptionDisplay').innerHTML=buyOptionHTML;
	 	document.getElementById('summaryTitleDisplay').innerHTML='Summary'+'<br>'+'<hr style="border: 0; height: 1px; background-color: grey;">';
	 	document.getElementById('PriceSummaryDisplay').innerHTML ='High Price: '+hp+'<br>' + 'Low Price: '+lp+'<br>'
	 	+'Open Price: '+op+'<br>'+'Close Price: '+cp;
	 	document.getElementById('CompanyInformationTitleDisplay').innerHTML='<br>'+'<hr style="border: 0; height: 1px; background-color: grey;">'+'<br>'+'Company Information'+'<br>';
	 	document.getElementById('CompanyInformationDisplay').innerHTML ='IPO Date: '+ipo+'<br>'+'Market Cap($M): '+mc+
	 	'<br>'+'Share Outstanding: '+so +'<br>'+'Website: '+web+'<br>'+'Phone: '+phone;
	 	if(json.isOpen){
        	isOpen=1;
        }
        
    	 	if(PercentageChange<0){
    	 	document.getElementById('stockPricingDisplay').style.color='red';
    	 	document.getElementById('timeStampDisplay').style.color='red';
    	 	document.getElementById('stockPricingDisplay').innerHTML=currentPrice+'<br>'+'▼'+change+'('+PercentageChange+'%)';
    	 	}
    	 	else if(PercentageChange==0){
    	 		document.getElementById('stockPricingDisplay').style.color='black';
        	 	document.getElementById('timeStampDisplay').style.color='black';
        	 	document.getElementById('stockPricingDisplay').innerHTML=currentPrice+'<br>'+'-'+change+'('+PercentageChange+'%)';	
    	 	}
    	 	else{
    	 	document.getElementById('stockPricingDisplay').style.color='green';	
    	 	document.getElementById('timeStampDisplay').style.color='green';
    	 	document.getElementById('stockPricingDisplay').innerHTML=currentPrice+'<br>'+'▲'+change+'('+PercentageChange+'%)';
    	 	}
    	 	 if(isOpen){
    	    	 	document.getElementById('marketStatusDisplay').innerHTML='Market is Open';
    	    	 	document.getElementById('timeStampDisplay').innerHTML=time.toLocaleString('en-US', fullTimeStamp);
    	    	 	}
    	    	 	else{
    	    	 		document.getElementById('marketStatusDisplay').innerHTML='Market is Closed';
    	    	 		document.getElementById('timeStampDisplay').innerHTML= time.toLocaleString('en-US', onlyDateTimeStamp)+'13:00:00';
    	    	 	}
	 	
	 	params={
	 	user_id:-2,
	 	ticker: ticker,
	 	price: currentPrice,
	 	};
	 	console.log("still in the fetch check numStock:"+document.getElementById("Quantity").value);
    } catch (err) {
        console.error('Request failed', err);
        document.getElementById('ErrorDisplay').textContent = 'Fetch data error: ' + error.message;
    }
}



function tradeBuyStock(quantity,event){
	 event.preventDefault();
	 params.numStock = quantity;
	 let baseURL = window.location.origin + "/Assignment4/";
	    var url = new URL("TradeServlet", baseURL);
	    console.log("URL: " + url);
	    console.log("Params:", params);
	    console.log("User ID:", params.user_id);
	    console.log("Ticker:", params.ticker);
	    console.log("Number of Stocks:", params.numStock);
	    console.log("Price:", params.price);
	    fetch(url, {
	        method: "POST",         
	        headers: {
	            "Content-type": "application/json"  
	        },
	        body: JSON.stringify(params)
	    })
	    .then(response => {
	    	if (!response.ok) {
	            throw new Error('Server response failed: ' + response.statusText);
	        }
	    	console.log(response);
	    	return response.json();
	    }) 
	    .then((json) => {
    	console.log("Response JSON: "+json);
    	
    	if('error' in json){
    	alert( json.error);	
    	}
    	else{
    	alert(json.msg);
    		}
	    })
	    .catch(error=> {
	        console.log('Requ est failed', error);
	    });
	    console.log("tradeBuyStock(event) complete");
}


</script>
</body>
</html>